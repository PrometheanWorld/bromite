From: "guangxi.Chen" <gxchen@nd.com.cn>
Date: Tue, 22 Nov 2022 15:01:15 +0800
Subject: Implement IDP lib

---
 base/BUILD.gn                                 |  2 ++
 .../org/chromium/base/PrometheanManager.java  | 33 +++++++++++++++++++
 .../base/SplitMonochromeApplication.java      |  2 ++
 third_party/android_deps/build.gradle         |  2 ++
 .../main/groovy/BuildConfigGenerator.groovy   |  1 +
 5 files changed, 40 insertions(+)
 create mode 100644 base/android/java/src/org/chromium/base/PrometheanManager.java

diff --git a/base/BUILD.gn b/base/BUILD.gn
--- a/base/BUILD.gn
+++ b/base/BUILD.gn
@@ -4178,6 +4178,7 @@ if (is_android) {

     deps = [
       "//third_party/android_deps:com_prometheanworld_telemetry_java",
+      "//third_party/android_deps:com_prometheanworld_identity_api_java",
       ":jni_java",
       "//build/android:build_java",
       "//third_party/android_deps:com_google_code_findbugs_jsr305_java",
@@ -4234,6 +4235,7 @@ if (is_android) {
       "android/java/src/org/chromium/base/PowerMonitor.java",
       "android/java/src/org/chromium/base/PowerMonitorForQ.java",
       "android/java/src/org/chromium/base/Predicate.java",
+      "android/java/src/org/chromium/base/PrometheanManager.java",
       "android/java/src/org/chromium/base/Promise.java",
       "android/java/src/org/chromium/base/RadioUtils.java",
       "android/java/src/org/chromium/base/StreamUtil.java",
diff --git a/base/android/java/src/org/chromium/base/PrometheanManager.java b/base/android/java/src/org/chromium/base/PrometheanManager.java
new file mode 100644
--- /dev/null
+++ b/base/android/java/src/org/chromium/base/PrometheanManager.java
@@ -0,0 +1,33 @@
+package org.chromium.base;
+
+import com.prometheanworld.identity.impl.PrometheanProfileImpl;
+import com.prometheanworld.identity.dto.response.LoginStatusResponse;
+import com.prometheanworld.identity.handler.response.LoginStatusHandler;
+
+import org.chromium.base.ContextUtils;
+
+public class PrometheanManager {
+
+    public static final PrometheanManager INSTANCE = new PrometheanManager();
+
+    private PrometheanProfileImpl mProfileImpl;
+
+    private boolean mIsLogin;
+
+    private PrometheanManager() {
+        mProfileImpl = new PrometheanProfileImpl(ContextUtils.getApplicationContext());
+    }
+
+    public void updateLoginStatus() {
+        mProfileImpl.getLoginStatus(new LoginStatusHandler() {
+            @Override
+            public void handle(LoginStatusResponse loginStatusResponse) {
+                mIsLogin = loginStatusResponse.isLoggedIn;
+            }
+        });
+    }
+
+    public boolean isLogin() {
+        return mIsLogin;
+    }
+}
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/base/SplitMonochromeApplication.java b/chrome/android/java/src/org/chromium/chrome/browser/base/SplitMonochromeApplication.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/base/SplitMonochromeApplication.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/base/SplitMonochromeApplication.java
@@ -7,6 +7,7 @@ package org.chromium.chrome.browser.base;
 import android.content.Context;

 import org.chromium.android_webview.nonembedded.WebViewApkApplication;
+import org.chromium.base.PrometheanManager;
 import org.chromium.base.TelemetryUtils;
 import org.chromium.base.library_loader.LibraryProcessType;
 import org.chromium.build.annotations.IdentifierNameString;
@@ -48,6 +49,7 @@ public class SplitMonochromeApplication extends SplitChromeApplication {
     public void onCreate() {
         super.onCreate();
         TelemetryUtils.init();
+        PrometheanManager.INSTANCE.updateLoginStatus();
     }

     @Override
diff --git a/third_party/android_deps/build.gradle b/third_party/android_deps/build.gradle
--- a/third_party/android_deps/build.gradle
+++ b/third_party/android_deps/build.gradle
@@ -138,6 +138,8 @@ dependencies {
     compile ("com.prometheanworld:telemetry:${prometheanLibVersion}") {
       exclude group: 'com.prometheanworld', module: 'activpanel'
     }
+    // idp library
+    compile 'com.prometheanworld:identity_api:latest.release'

     // Upstream guava introduced versions with -android suffix starting with version
     // 22 to remove incompatible code with android. Thus we keep two jars, one for
diff --git a/third_party/android_deps/buildSrc/src/main/groovy/BuildConfigGenerator.groovy b/third_party/android_deps/buildSrc/src/main/groovy/BuildConfigGenerator.groovy
--- a/third_party/android_deps/buildSrc/src/main/groovy/BuildConfigGenerator.groovy
+++ b/third_party/android_deps/buildSrc/src/main/groovy/BuildConfigGenerator.groovy
@@ -923,6 +923,7 @@ class BuildConfigGenerator extends DefaultTask {
               break
             case 'com_prometheanworld_telemetry':
             case 'com_prometheanworld_activpanel':
+            case 'com_prometheanworld_identity_api':
             case 'com_mixpanel_android_mixpanel_android':
                 sb.append('  resource_overlay = false\n')
                 sb.append('  extract_native_libraries = true\n')
--
2.34.1